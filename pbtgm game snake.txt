#include <bits/stdc++.h>

#ifdef _WIN32
    #include <conio.h>
    #include <windows.h>
#else
    #include <unistd.h>
    #include <termios.h>
    #include <fcntl.h>
#endif

using namespace std;

enum Direction { UP, DOWN, LEFT, RIGHT };

struct Point {
    int x, y;
    bool operator==(const Point& other) const {
        return x == other.x && y == other.y;
    }
};

#ifdef _WIN32
void sleep_ms(int ms) { Sleep(ms); }
int kbhit_nb() { return _kbhit(); }
int getch_nb() { return _getch(); }
#else
void sleep_ms(int ms) { usleep(ms * 1000); }

int kbhit_nb() {
    termios oldt, newt;
    int ch;
    int oldf;

    tcgetattr(STDIN_FILENO, &oldt);
    newt = oldt;
    newt.c_lflag &= ~(ICANON | ECHO);
    tcsetattr(STDIN_FILENO, TCSANOW, &newt);
    oldf = fcntl(STDIN_FILENO, F_GETFL, 0);
    fcntl(STDIN_FILENO, F_SETFL, oldf | O_NONBLOCK);

    ch = getchar();

    tcsetattr(STDIN_FILENO, TCSANOW, &oldt);
    fcntl(STDIN_FILENO, F_SETFL, oldf);

    if (ch != EOF) {
        ungetc(ch, stdin);
        return 1;
    }
    return 0;
}

int getch_nb() {
    termios oldt, newt;
    int ch;
    tcgetattr(STDIN_FILENO, &oldt);
    newt = oldt;
    newt.c_lflag &= ~(ICANON | ECHO);
    tcsetattr(STDIN_FILENO, TCSANOW, &newt);
    ch = getchar();
    tcsetattr(STDIN_FILENO, TCSANOW, &oldt);
    return ch;
}
#endif

class SnakeGame {
public:
    SnakeGame(int w = 40, int h = 20) : width(w), height(h), score(0), gameOver(false), dir(RIGHT) {
        reset();
    }

    void reset() {
        snake.clear();
        int sx = width / 4, sy = height / 2;
        snake.push_back({sx, sy});
        snake.push_back({sx - 1, sy});
        snake.push_back({sx - 2, sy});
        placeFood();
        score = 0;
        dir = RIGHT;
        gameOver = false;
    }

    void run() {
        while (!gameOver) {
            draw();
            input();
            update();
            sleep_ms(100);
        }

        draw();
        cout << "=== GAME OVER ===\n";
        cout << "Score: " << score << endl;
        cout << "Tekan 'r' untuk main lagi / 'q' untuk keluar\n";

        while (true) {
            if (kbhit_nb()) {
                char c = getch_nb();
                if (c == 'r' || c == 'R') {
                    reset();
                    run();
                    return;
                }
                if (c == 'q' || c == 'Q') {
                    return;
                }
            }
            sleep_ms(50);
        }
    }

private:
    int width, height, score;
    bool gameOver;
    Direction dir;
    vector<Point> snake;
    Point food;

    void placeFood() {
        random_device rd;
        mt19937 gen(rd());
        uniform_int_distribution<> dx(1, width - 2);
        uniform_int_distribution<> dy(1, height - 2);

        while (true) {
            Point f{dx(gen), dy(gen)};
            bool conflict = false;
            for (auto &s : snake)
                if (s == f)
                    conflict = true;
            if (!conflict) {
                food = f;
                break;
            }
        }
    }

    void draw() {
        // ANSI CLEAR FIX (tidak berantakan)
        cout << "\033[2J\033[1;1H";

        for (int i = 0; i < width; i++) cout << '#';
        cout << "\n";

        for (int y = 1; y < height - 1; y++) {
            for (int x = 0; x < width; x++) {
                if (x == 0 || x == width - 1) cout << '#';
                else {
                    Point p{x, y};
                    if (p == food) cout << 'O';
                    else {
                        bool printed = false;
                        for (int i = 0; i < snake.size(); i++) {
                            if (snake[i] == p) {
                                cout << (i == 0 ? '@' : 'o');
                                printed = true;
                                break;
                            }
                        }
                        if (!printed) cout << ' ';
                    }
                }
            }
            cout << "\n";
        }

        for (int i = 0; i < width; i++) cout << '#';
        cout << "\n";

        cout << "Score: " << score << "   W/A/S/D atau Panah | Q: Keluar\n";
    }

    void input() {
        if (!kbhit_nb()) return;

        int c = getch_nb();

        // Windows arrow keys: 224 + code
        if (c == 224) {
            int c2 = getch_nb();
            if (c2 == 72) tryChange(UP);
            else if (c2 == 80) tryChange(DOWN);
            else if (c2 == 75) tryChange(LEFT);
            else if (c2 == 77) tryChange(RIGHT);
            return;
        }

        // Linux/mac arrow â†’ ESC [ A/B/C/D
        if (c == 27 && kbhit_nb()) {
            int c1 = getch_nb();
            if (c1 == '[' && kbhit_nb()) {
                int c2 = getch_nb();
                if (c2 == 'A') tryChange(UP);
                else if (c2 == 'B') tryChange(DOWN);
                else if (c2 == 'C') tryChange(RIGHT);
                else if (c2 == 'D') tryChange(LEFT);
                return;
            }
        }

        if (c == 'w' || c == 'W') tryChange(UP);
        else if (c == 's' || c == 'S') tryChange(DOWN);
        else if (c == 'a' || c == 'A') tryChange(LEFT);
        else if (c == 'd' || c == 'D') tryChange(RIGHT);
        else if (c == 'q' || c == 'Q') gameOver = true;
    }

    void tryChange(Direction newDir) {
        if ((dir == UP && newDir == DOWN) ||
            (dir == DOWN && newDir == UP) ||
            (dir == LEFT && newDir == RIGHT) ||
            (dir == RIGHT && newDir == LEFT))
            return;

        dir = newDir;
    }

    void update() {
        Point head = snake[0];
        Point next = head;

        if (dir == UP) next.y--;
        else if (dir == DOWN) next.y++;
        else if (dir == LEFT) next.x--;
        else if (dir == RIGHT) next.x++;

        if (next.x <= 0 || next.x >= width - 1 || next.y <= 0 || next.y >= height - 1) {
            gameOver = true;
            return;
        }

        for (auto &s : snake)
            if (s == next) { gameOver = true; return; }

        snake.insert(snake.begin(), next);

        if (next == food) {
            score += 10;
            placeFood();
        } else {
            snake.pop_back();
        }
    }
};

int main() {
    SnakeGame game(40, 20);
    game.run();
    return 0;
}
